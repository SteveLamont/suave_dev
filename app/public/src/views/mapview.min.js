PivotViewer.Utils.loadScript("lib/wicket/wicket.min.js"),PivotViewer.Utils.loadCSS("lib/leaflet/leaflet.css"),PivotViewer.Utils.loadScript("lib/leaflet/leaflet.js");var markercluster_ok=!0;PivotViewer.Utils.loadScript("lib/oms.min.js"),markercluster_ok&&PivotViewer.Utils.loadScript("lib/markercluster/markerclusterer.min.js"),PivotViewer.Views.MapView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super(),this.locCache=[],this.map=null,this.markers=[],this.geometries=[],this.overlay,this.overlayBaseImageUrl=null,this.itemsToGeocode=[],this.startGeocode,this.geocodeZero,this.applyBookmark=!1,this.mapService=null,this.APIKey=null,this.geocodeService=null,this.hasGeometry=!1,this.areaValues=[],this.areaObj,this.buckets=[],this.icons=[],this.strokeColors=[],this.iconsSelected=[],this.selectedMarker=null,this.selectedGeometry=null,this.selectedBucket=-1;var t=this;$.subscribe("/PivotViewer/Views/Item/Selected",function(e){t.isActive&&(0<t.geometries.length?t.selectGeometry(e.item):t.selectMarker(e.item))})},setup:function(e,t,i,a,s){this.width=e,this.height=t,this.offsetX=i,this.offsetY=a,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,Modernizr.localstorage?this.localStorage=!0:this.localStorage=!1,window.mapView=this},apiLoaded:function(){var s=this,e={scrollwheel:!0,styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}],mapTypeId:"satellite",gestureHandling:"greedy"};if(this.map=new google.maps.Map(document.getElementById("pv-map-canvas"),e),this.oms=new OverlappingMarkerSpiderfier(this.map,{markersWontMove:!0,markersWontHide:!0,keepSpiderfied:!0,circleSpiralSwitchover:20}),markercluster_ok&&(this.markerCluster=new MarkerClusterer(this.map,[],{imagePath:"lib/markercluster/images/m",minimumClusterSize:2,maxZoom:17})),this.map.data.addListener("mouseover",function(e){this.map.data.revertStyle(),this.map.data.overrideStyle(e.feature,{strokeWeight:8,zindex:1e3})}),this.map.data.addListener("mouseout",function(e){this.map.data.revertStyle()}),this.map.data.addListener("click",function(e){if(e.feature.getProperty("itemTile")){var t=e.feature.getProperty("itemTile");$.publish("/PivotViewer/Views/Item/Selected",[{item:t}])}}),this.map.data.addListener("dblclick",function(e){if(alert(e.feature.getProperty("itemID")+" "+e.feature.getProperty("itemColor")),e.feature.getProperty("itemTile")){e.feature.getProperty("itemTile");return function(e){$.publish("/PivotViewer/Views/Item/PopViewer",[{item:e,all:[e],these:[]}])(e)}}}),google.maps.event.addListener(this.map,"zoom_changed",function(){$.publish("/PivotViewer/Views/Item/Updated",null),s.getOverlay()}),google.maps.event.addListener(this.map,"center_changed",function(){$.publish("/PivotViewer/Views/Item/Updated",null),s.getOverlay()}),null!=options.map_icons){var t=options.map_icons.path;if(null==t&&(t=""),null!=options.map_icons.icons){this.icons=[],this.iconsSelected=[];for(var a=0;a<options.map_icons.icons.length;a++){var i=t+options.map_icons.icons[a];this.icons.push(i),this.iconsSelected.push(i)}}if(null!=options.map_icons.icons_selected){var r=options.map_icons.icons_selected;this.iconsSelected=[];for(a=0;a<r.length;a++)this.iconsSelected.push(t+r[a])}}else this.iconsSelected=this.icons=["lib/markercluster/images/photo1.png","lib/markercluster/images/photo2.png","lib/markercluster/images/photo3.png","lib/markercluster/images/photo4.png","lib/markercluster/images/photo5.png","lib/markercluster/images/photo6.png","lib/markercluster/images/photo7.png","lib/markercluster/images/photo8.png","lib/markercluster/images/photo9.png","lib/markercluster/images/photo10.png"],this.strokeColors=["#7700FF","#0077FF","#00BBCC","#00AA00","#77FF77","#FFFF00","#FFAA00","#FF5500","#FF0000","#FFAAAA"];this.clearMarkers=function(){for(var e=0;e<this.tiles.length;e++){var t=this.tiles[e].marker;null!=t&&t.setMap(null)}this.markers=[],this.oms.clearMarkers()},this.clearGeometries=function(){var t=this.map;this.map.data.forEach(function(e){t.data.remove(e)}),this.geometries=[]},this.selectGeometry=function(e){var t=s.getBucketNumber(e);if(e.Geometry==s.selectedGeometry){t=s.getBucketNumber(e);s.selectedGeometry=null,s.selectedBucket=-1,$(".pv-toolbarpanel-info").empty(),$(".pv-altinfopanel").fadeIn()}else{t instanceof Array&&(t=t[0]),s.selected=e,s.selectedGeometry,s.selectedGeometry=e.Geometry,s.selectedBucket=t;var i=new google.maps.LatLngBounds;e.Geometry.forEachLatLng(function(e){i.extend(e)}),this.map.fitBounds(i),$(".pv-toolbarpanel-info").empty();var a="<img style='height:15px;width:auto' src='"+s.icons[t]+"'></img>";s.buckets[t].startRange==s.buckets[t].endRange?a+=s.buckets[t].startRange:a+=s.buckets[t].startRange+" to "+s.buckets[t].endRange,$(".pv-toolbarpanel-info").append(a),$(".pv-altinfopanel").hide()}},this.selectMarker=function(e){var t=s.getBucketNumber(e);if(e.marker==s.selectedMarker)e.marker.setIcon(s.icons[t]),s.selected=null,s.selectedMarker.setZIndex(0),s.selectedMarker=null,s.selectedBucket=-1,$(".pv-toolbarpanel-info").empty(),$(".pv-altinfopanel").fadeIn();else{t instanceof Array&&(t=t[0]),e.marker.setIcon(s.iconsSelected[t]),e.marker.setZIndex(1e9),s.selected=e,null!=s.selectedMarker&&(s.selectedMarker.setZIndex(0),s.selectedMarker.setIcon(s.icons[s.selectedBucket])),s.selectedMarker=e.marker,s.selectedBucket=t,s.map.panTo(e.loc),$(".pv-toolbarpanel-info").empty();var i="<img style='height:15px;width:auto' src='"+s.icons[t]+"'></img>";s.buckets[t].startRange==s.buckets[t].endRange?i+=s.buckets[t].startRange:i+=s.buckets[t].startRange+" to "+s.buckets[t].endRange,$(".pv-toolbarpanel-info").append(i),$(".pv-altinfopanel").hide()}},this.message="Click for info",this.message+="\nDouble click to view ",this.newGeometry=function(i){var a,e="",s=[];this.map;if(!i.Geometry){if(-1<i.WKT.indexOf("MULTILINESTRING((")){var t=[];startidx=i.WKT.indexOf("MULTILINESTRING((")+17,endidx=i.WKT.indexOf("))");var r=(e=i.WKT.substr(startidx,endidx)).split("),(");r.forEach(function(e){coords=e.split(","),s=[],coords.forEach(function(e){pair=e.split(" "),Math.abs(parseFloat(pair[1]))<85?s.push({lat:parseFloat(pair[1]),lng:parseFloat(pair[0])}):0<parseFloat(pair[1])?s.push({lat:85,lng:parseFloat(pair[0])}):s.push({lat:-85,lng:parseFloat(pair[0])})}),a=new google.maps.Data.LineString(s),t.push(a)});var o=new google.maps.Data.MultiLineString(t);i.Geometry=o,this.geometries.push(o)}if(-1<i.WKT.indexOf("MULTIPOLYGON (((")){var n=[];startidx=i.WKT.indexOf("MULTIPOLYGON (((")+16,endidx=i.WKT.indexOf(")))"),e=i.WKT.substr(startidx,endidx);var l=[],c=e.split(")),((");if(1<c.length);c.forEach(function(e){n=[],1<(r=e.split("),(")).length&&2,r.forEach(function(e){coords=e.split(","),s=[],coords.forEach(function(e){pair=e.trim().split(" "),Math.abs(parseFloat(pair[1]))<85?s.push({lat:parseFloat(pair[1]),lng:parseFloat(pair[0])}):0<parseFloat(pair[1])?s.push({lat:85,lng:parseFloat(pair[0])}):s.push({lat:-85,lng:parseFloat(pair[0])})}),a=new google.maps.Data.LinearRing(s),n.push(a)});var t=new google.maps.Data.Polygon(n);l.push(t)}),i.Geometry=new google.maps.Data.MultiPolygon(l)}}this.map.data.add({geometry:i.Geometry}),this.geometries.push(i.Geometry);var p=this.buckets.ids,h=this.strokeColors;this.map;this.map.data.forEach(function(e){var t=e.getGeometry();t&&t==i.Geometry&&(e.setProperty("itemID",i.item.id),e.setProperty("itemColor",h[p[i.item.id]]),e.setProperty("itemTile",i),e.setProperty("itemName",i.item.name))})},this.newMarker=function(e){e.marker=new google.maps.Marker({position:e.loc,map:this.map,tile:e,title:this.message}),e.marker.setIcon(this.icons[this.buckets.ids[e.item.id]]);var t,s,r,o,i=null;google.maps.event.addListener(e.marker,"click",(t=e,function(){null!=i&&clearTimeout(i),i=setTimeout(function(){$.publish("/PivotViewer/Views/Item/Selected",[{item:t}])})})),google.maps.event.addListener(e.marker,"dblclick",(s=e,r=this.markers,o=this.oms,function(){for(var e=o.markersNearAnyOtherMarker(),t=[],i=0;i<r.length;i++)t.push(r[i].tile.item);var a=[];for(i=0;i<e.length;i++)a.push(e[i].tile.item);$.publish("/PivotViewer/Views/Item/PopViewer",[{item:s,all:t,near:a}])})),this.markers.push(e.marker),this.oms.addMarker(e.marker)},this.refitBounds=function(){var e=[];for(a=0;a<this.filterList.length;a++){var t=this.filterList[a];t.marker&&null!=t.marker&&e.push(t.marker.getPosition())}var i=new google.maps.LatLngBounds;e.forEach(function(e){i.extend(e)}),this.map.data.forEach(function(e){e.getGeometry()&&e.getGeometry().forEachLatLng(function(e){i.extend(e)})}),i.isEmpty()&&i.extend({lat:-80,lng:-1}).extend({lat:80,lng:1}),this.map.fitBounds(i)},this.getOverlay=function(){if(null!=this.overlayBaseImageUrl){var e=this.map.getBounds();if(e){var t=e.getSouthWest(),i=e.getNorthEast(),a=$("#pv-map-canvas").width(),s=$("#pv-map-canvas").height();this.overlay&&this.overlay.setMap(null);var r=this.overlayBaseImageUrl+"&bbox="+t.lng()+","+t.lat()+","+i.lng()+","+i.lat()+"&width="+a+"&height="+s;this.overlay=new google.maps.GroundOverlay(r,e,{opacity:.4}),this.overlay.setMap(this.map)}}},$(".pv-mainpanel").append("<div class='pv-altinfopanel' id='pv-altinfopanel'></div>"),$(".pv-altinfopanel").css("left",$(".pv-mainpanel").offset().left+$(".pv-mainpanel").width()-205+"px").css("height",$(window).height()-$(".pv-toolbarpanel").height()-58+"px"),this.activate()},setOptions:function(e){if($(".pv-viewpanel").append("<div class='pv-mapview-canvas' id='pv-map-canvas'></div>"),null==e.MapService||"openstreetmap"!=e.MapService.toLowerCase())this.APIKey=null!=e.GoogleAPIKey?e.GoogleAPIKey:"AIzaSyAnPWLPKMYKQZa2g1p11d_vllwwT7CFdQg",this.mapService="google",PivotViewer.Utils.loadScript("lib/wicket/wicket-gmap3.min.js"),"Google"==e.GeocodeService?this.geocodeService="Google":GeocodeService="Nominatim";else{this.mapService="openstreetmap",this.geocodeService="Nominatim",PivotViewer.Utils.loadScript("lib/wicket/wicket-leaflet.min.js"),this.map=new L.Map(document.getElementById("pv-map-canvas"));this.osm=new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Map data Â© OpenStreetMap contributors"}),this.map.addLayer(this.osm),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Red.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Yellow.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/DarkGreen.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Blue.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Purple.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Orange.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Pink.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Sky.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Lime.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Gold.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Green.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/RedDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/YellowDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/DarkGreenDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/BlueDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/PurpleDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/OrangeDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/PinkDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/SkyDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/LimeDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/GoldDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/GreenDot.png"}}));var a=this;this.map.on("zoomend",function(e){$.publish("/PivotViewer/Views/Item/Updated",null),a.getOverlay()}),this.map.on("moveend",function(e){$.publish("/PivotViewer/Views/Item/Updated",null),a.getOverlay()}),this.clearMarkers=function(){for(var e=0;e<this.tiles.length;e++){var t=this.tiles[e].marker;null!=t&&this.map.removeLayer(t)}this.markers=[],this.oms.clearMarkers()},this.selectMarker=function(e){var t=a.getBucketNumber(e);if(e.marker==a.selectedMarker)e.marker.setIcon(new a.icons[t]),a.selected=null,a.selectedMarker.setZIndexOffset(0),a.selectedMarker=null,a.selectedBucket=-1,$(".pv-toolbarpanel-info").empty(),$(".pv-altinfopanel").fadeIn();else{e.marker.setIcon(new a.iconsSelected[t]),e.marker.setZIndexOffset(1e9),a.selected=e,null!=a.selectedMarker&&(a.selectedMarker.setIcon(new a.icons[a.selectedBucket]),a.selectedMarker.setZIndexOffset(0)),a.selectedMarker=e.marker,a.selectedBucket=t,a.map.panTo(e.loc),$(".pv-toolbarpanel-info").empty();var i="<img style='height:15px;width:auto' src='"+e.marker._icon.src+"'></img>";a.buckets[t].startRange==a.buckets[t].endRange?i+=a.buckets[t].startRange:i+=a.buckets[t].startRange+" to "+a.buckets[t].endRange,$(".pv-toolbarpanel-info").append(i),$(".pv-altinfopanel").hide()}},this.newMarker=function(e){var t;return e.marker=new L.Marker(e.loc,{title:e.item.name}),this.map.addLayer(e.marker),e.marker.setIcon(new this.icons[this.buckets.ids[e.item.id]]),e.marker.on("click",(t=e,function(){$.publish("/PivotViewer/Views/Item/Selected",[{item:t}])})),e.marker},this.refitBounds=function(){var e=[];for(i=0;i<this.filterList.length;i++){var t=this.filterList[i];null!=t.marker&&e.push(t.marker.getLatLng())}var a=new L.LatLngBounds(e);this.map.data.forEach(function(e){e.getGeometry().forEachLatLng(latlng),a.extend(latlng)}),this.map.fitBounds(a)},this.getOverlay=function(){var e=this.map.getBounds(),t=e.getWest(),i=e.getEast(),a=e.getNorth(),s=e.getSouth(),r=this.map.getSize(),o=r.x,n=r.y;if(null!=this.overlayBaseImageUrl){this.overlay&&this.map.hasLayer(this.overlay)&&this.map.removeLayer(this.overlay);var l=this.overlayBaseImageUrl+"&bbox="+t+","+s+","+i+","+a+"&width="+o+"&height="+n;this.overlay=new L.imageOverlay(l,e,{opacity:.4}),this.overlay.addTo(this.map)}}}null!=e.MapOverlay&&(this.overlayBaseImageUrl=e.MapOverlay)},activate:function(){if(Modernizr.canvas&&("google"==this.mapService&&null==this.map?PivotViewer.Utils.loadScript("https://maps.googleapis.com/maps/api/js?key="+this.APIKey+"&sensor=false&callback=mapView.apiLoaded"):this._super(),$(".pv-toolbarpanel-info").fadeIn(),$(".pv-altinfopanel").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").hide(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","0"),$("#MAIN_BODY").css("overflow","auto"),$(".pv-mapview-canvas").fadeIn(),$(".pv-toolbarpanel-sort").fadeIn(),null!=this.map)){this.refitBounds(),this.markerCluster.repaint();var e=this;setTimeout(function(){e.markerCluster.repaint()},500)}},deactivate:function(){this._super(),$(".pv-altinfopanel").fadeOut(),$(".pv-toolbarpanel-info").fadeOut(),$(".pv-mapview-canvas").fadeOut(),$(".pv-toolbarpanel-sort").fadeOut()},getBucketNumber:function(e){var t=this.buckets.ids[e.item.id];return null!=t?t:-1},bucketize:function(e,t,i){if(category=PivotCollection.getCategoryByName(i),null==t[0].item.getFacetByName(i))return[{startRange:"(no info)",endRange:"(no info)",tiles:[t[0]],values:["(no info)"],startLabel:"(no info)",endLabel:"(no info)"}];for(var a=t[0].item.getFacetByName(i).values[0].value,s=t.length-1;0<s&&null==t[s].item.getFacetByName(i);s--);var r=t[s].item.getFacetByName(i).values[0].value;return category.isDateTime()?(a=new Date(a),9<(r=new Date(r)).getFullYear()-a.getFullYear()+a.getFullYear()%10?PivotViewer.Utils.getBuckets(t,i,function(e){var t=new Date(e.value).getFullYear();return t-t%10},function(e){var t=new Date(e.value).getFullYear();return t-t%10+"s"}):r.getFullYear()>a.getFullYear()?PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getFullYear()},function(e){return new Date(e.value).getFullYear().toString()}):r.getMonth()>a.getMonth()?PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getMonth()},function(e){var t=new Date(e.value);return PivotViewer.Utils.getMonthName(t)+" "+t.getFullYear()}):r.getDate()>a.getDate()?PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getDate()},function(e){var t=new Date(e.value);return PivotViewer.Utils.getMonthName(t)+" "+t.getDate()+", "+t.getFullYear()}):r.getHours()>a.getHours()?PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getHours()},function(e){var t=new Date(e.value);return PivotViewer.Utils.getMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+PivotViewer.Utils.getHour(t)+" "+PivotViewer.Utils.getMeridian(t)}):r.getMinutes()>a.getMinutes()?PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getMinutes()},function(e){var t=new Date(e);return PivotViewer.Utils.getMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+PivotViewer.Utils.getHour(t)+":"+t.getMinutes()+" "+PivotViewer.Utils.getMeridian(t)}):PivotViewer.Utils.getBuckets(t,i,function(e){return new Date(e.value).getSeconds()},function(e){var t=new Date(e.value);return PivotViewer.Utils.getMonthName(t)+" "+t.getDate()+", "+t.getFullYear()+" "+PivotViewer.Utils.getHour(t)+":"+t.getMinutes()+"::"+t.getSeconds()+" "+PivotViewer.Utils.getMeridian(t)})):PivotViewer.Utils.getBuckets(t,i)},filter:function(){var e=0;this.buckets=this.bucketize(this.tiles,this.filterList,this.sortCategory),$(".pv-toolbarpanel-info").empty(),null==this.selected&&$(".pv-altinfopanel").fadeIn();for(var t=null,i=null,a=null,s=0;s<PivotCollection.categories.length;s++){var r,o=(r=PivotCollection.categories[s]).name.toLowerCase();if(r.isLocation()){0==r.uiInit&&PV.initUICategory(r);break}if(0<=o.indexOf("geometry")&&(a=r),0<=o.indexOf("latitude")?t=r:0<=o.indexOf("longitude")&&(i=r),null!=t&&null!=i){0==t.uiInit&&PV.initUICategory(t),0==i.uiInit&&PV.initUICategory(i);break}null!=a&&(this.hasGeometry=!0,0==a.uiInit&&PV.initUICategory(a))}for(s=0;s<this.filterList.length;s++){var n=this.filterList[s];if(Settings.showMissing||!n.missing){if(null==n.loc){var l=null,c=null;if(null!=t&&null!=i){if(l=n.item.getFacetByName(t.name),c=n.item.getFacetByName(i.name),null!=l&&null!=c){var p=l.values[0].value;null!=(m=c.values[0].value)&&null!=p&&("string"==typeof p&&(p=parseFloat(p)),"string"==typeof m&&(m=parseFloat(m)),isNaN(m)||isNaN(p)||(n.loc=new L.LatLng(p,m)))}}else if(null!=r){var h=n.item.getFacetByName(r.name);if(null==h)continue;var u=h.values[0].value;if(0==u.toLowerCase().indexOf("point(")){var m=parseFloat(u.substring(6,u.indexOf(" ",6)-6));p=parseFloat(u.substring(u.indexOf(" ",6)+1,u.indexOf(")")-(u.indexOf(" ")+1)));isNaN(p)||isNaN(m)||(n.loc=new L.LatLng(p,m))}else if(-1<u.indexOf(",")){p=parseFloat(u.substring(0,u.indexOf(","))),m=parseFloat(u.substring(u.indexOf(",")));if(isNaN(p)||isNaN(m)){if(1<u.length){var g=u.toUpperCase();if(null!=this.locCache[g])n.loc=this.locCache[g];else this.hasGeometry||e<1e3&&(null==this.itemsToGeocode[g]&&(this.itemsToGeocode[g]=[],e++),this.itemsToGeocode[g].push(n))}}else n.loc=new L.LatLng(p,m)}}}if(null==n.WKT&&null!=a){var d=(l=n.item.getFacetByName(a.name)).values[0].value;d=d.replace(/, /g,","),n.WKT=d}}}0<e&&this.getLocationsFromNames(),$(".pv-mapview-canvas").css("height",this.height-12+"px"),$(".pv-mapview-canvas").css("width",this.width-415+"px"),this.createMap()},getButtonImage:function(){return"images/MapView.png"},getButtonImageSelected:function(){return"images/MapViewSelected.png"},getViewName:function(){return"Map View"},makeGeocodeCallBack:function(n){var l=this;return function(e){results=e.results,status=e.status;var t=new L.LatLng(0,0);if(status==google.maps.GeocoderStatus.OK){var i=results[0].geometry.location,a=i.lat,s=i.lng;a&&s&&(t=new L.LatLng(a,s))}l.locCache[n]=t,l.localStorage&&localStorage.setItem(n,JSON.stringify(t));for(var r=0;r<l.itemsToGeocode[n].length;r++)l.itemsToGeocode[n][r].loc=t;delete l.itemsToGeocode[n];var o=new Date;20<(o.getTime()-l.geocodeZero.getTime())/1e3?(l.redrawMarkers(),l.startGeocode=new Date):2<(o.getTime()-l.startGeocode.getTime())/1e3&&(l.redrawMarkers(),l.refitBounds(),l.getOverlay(),l.startGeocode=new Date),0==Object.keys(l.itemsToGeocode).length&&l.createMap()}},geocode:function(e,t){var i="http://www.datasciencetoolkit.org/maps/api/geocode/json?sensor=false&address="+encodeURIComponent(e);$.ajax({type:"GET",url:i,dataType:"jsonp",success:function(e){t(e)}})},getLocationsFromNames:function(){for(var e=0;e<Object.keys(this.itemsToGeocode).length;e++){var t=Object.keys(this.itemsToGeocode)[e];this.geocode(t,this.makeGeocodeCallBack(t))}this.startGeocode=new Date,this.startGeocode.setSeconds(this.startGeocode.getSeconds()+2),this.geocodeZero=new Date},createMap:function(){this.createMarkers(),this.createGeometries(),this.refitBounds(),this.getOverlay(),this.createLegend()},createGeometries:function(){if(this.clearGeometries&&this.clearGeometries(),1e3<this.tiles.length&&this.filterList.length==this.tiles.length);else{for(i=0;i<this.filterList.length;i++){var e=this.filterList[i];null==e.WKT||!Settings.showMissing&&e.missing||this.newGeometry(e)}this.map.data.setStyle(function(e){var t="gray";return e.getProperty("itemColor")&&(t=e.getProperty("itemColor")),{fillColor:t,strokeColor:t,strokeWeight:2}})}},createMarkers:function(){for(markercluster_ok&&this.markerCluster.clearMarkers(),this.clearMarkers(),i=0;i<this.filterList.length;i++){var e=this.filterList[i];null==e.loc||!Settings.showMissing&&e.missing||this.newMarker(e)}markercluster_ok&&this.markerCluster.addMarkers(this.markers,!1)},drawArea:function(){var t,i=new Wkt.Wkt;this.areaObj&&this.map.removeLayer(this.areaObj);for(var e=0;e<this.areaValues.length;e++)if(this.areaValues[e].id==this.selected.item.id){t=this.areaValues[e].area;break}if(t){var a=!0;try{i.read(t)}catch(e){try{i.read(t.replace("\n","").replace("\r","").replace("\t",""))}catch(e){"WKTError"===e.name&&(Debug.log("Wicket could not understand the WKT string you entered. Check that you have parentheses balanced, and try removing tabs and newline characters."),a=!1)}}if(a)if(this.areaObj=i.toObject({color:"#990000",fillColor:"#EEFFCC",fillOpacity:.6}),Wkt.isArray(this.areaObj))for(var s=0;s<this.areaObj.length;s++)this.map.addLayer(this.areaObj[s]);else this.map.addLayer(this.areaObj)}},redrawMarkers:function(){this.createMarkers(),this.drawArea()},createLegend:function(){var e=$(".pv-altinfopanel").width()-32;$(".pv-altinfopanel").empty(),$(".pv-altinfopanel").append("<div class='pv-legend-heading' style='height:28px' title='"+this.sortCategory+"'>"+this.sortCategory+"</div>");var t="<table id='pv-legend-data' style='color:#484848;'>";if(this.hasGeometry&&0==this.geometries.length)t+="<tr><td>There are too many features in this data set to draw all at once. Please select one or more facet categories on the left to draw the associated features</div></td>";else{for(var i=0;i<this.buckets.length;i++){if(this.hasGeometry)t+="<tr><td width='25' height='25'><div style='width: 100%; height: 100%; background-color: "+this.strokeColors[i]+"'></div></td>";else t+="<tr><td><img src='"+("google"==this.mapService?this.icons[i]:(new this.icons[i]).options.iconUrl)+"'></img></td>";this.buckets[i].startRange==this.buckets[i].endRange?t+="<td><div style='overflow:hidden;white-space:nowrap;width:"+e+"px;text-overflow:ellipsis'>"+this.buckets[i].startLabel+"</div></td></tr>":t+="<td><div style='overflow:hidden;white-space:nowrap;width:"+e+"px;text-overflow:ellipsis'>"+this.buckets[i].startLabel+" to "+this.buckets[i].endLabel+"</div></td></tr>"}t+="<tr><td colspan='2'></hr> *Click items on the map to see details.</td></tr>"}t+="</table>",$(".pv-altinfopanel").append(t),"1"==document.getElementById("pv-toolbarpanel-countbox").innerHTML&&setTimeout(function(){$(".pv-altinfopanel").hide()},300)}});